statement ok
create table testkeys (a int primary key, b int unique)

statement ok rowcount 3
insert into testkeys values (1,1),(2,2),(3,3)

# The following joins can be converted into semijoins
plan select y from (values (1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.a
project (
| semijoin (
| |  [  [ int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."a" NOT NULL UNIQUE HASHCOL  ]
| ) [ "y"."y" = "testkeys"."a" NOT NULL HASHCOL  ]
) [ "y"."y" ]

plan select y from (values (1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.b
project (
| semijoin (
| |  [  [ int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."b" UNIQUE HASHCOL  ]
| ) [ "y"."y" = "testkeys"."b" HASHCOL  ]
) [ "y"."y" ]

query T nosort
plan select y from (values (1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.a or (y.y is null and testkeys.a is null)
----
project (
| semijoin (
| |  [  [ int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."a" NOT NULL UNIQUE HASHCOL  ]
| ) [ "y"."y" = "testkeys"."a" NOT NULL HASHCOL  ]
) [ "y"."y" ]

# Here the inner join cannot be converted to a semijoin
query T nosort
plan select y from (values (NULL),(1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.b or (y.y is null and testkeys.b is null)
----
project (
| join (
| |  [  [ int "NULL", int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."b" UNIQUE HASHCOL  ]
| ) [ "y"."y" * = "testkeys"."b" HASHCOL  ]
) [ "y"."y" ]

statement ok
alter table testkeys drop constraint testkeys_a_pkey

statement ok
alter table testkeys drop constraint testkeys_b_unique

# No more unique properties
query T nosort
plan select y from (values (1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.a
----
project (
| join (
| |  [  [ int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."a" NOT NULL ]
| ) [ "y"."y" = "testkeys"."a" NOT NULL ]
) [ "y"."y" ]

query T nosort
plan select y from (values (1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.b;
----
project (
| join (
| |  [  [ int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."b" ]
| ) [ "y"."y" = "testkeys"."b" ]
) [ "y"."y" ]

statement ok
start transaction

statement ok
alter table testkeys add constraint testkeys_a_pkey primary key (a)

statement ok
alter table testkeys add constraint testkeys_b_unique unique (b)

statement ok
rollback

query T nosort
plan select y from (values (1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.a
----
project (
| join (
| |  [  [ int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."a" NOT NULL ]
| ) [ "y"."y" = "testkeys"."a" NOT NULL ]
) [ "y"."y" ]

query T nosort
plan select y from (values (1),(2),(cast(3 as int))) y(y) inner join testkeys on y.y = testkeys.b;
----
project (
| join (
| |  [  [ int "1", int "2", int "3" ] as "y"."y" ],
| | table("sys"."testkeys") [ "testkeys"."b" ]
| ) [ "y"."y" = "testkeys"."b" ]
) [ "y"."y" ]

statement ok
DROP TABLE testkeys

