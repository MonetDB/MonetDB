statement ok
create type kv as (key varchar, value varchar)

statement ok
create type elem as (element kv)

statement ok
create type webusr as (list elem[])

statement ok
create type loc as (list elem[])

statement ok
create type actionfields as (list elem[])

statement ok
create type attributes as (list elem[])

statement ok
create type oelement as (type varchar, id varchar, attributes attributes)

statement ok
create type oelement_container as (element oelement)

statement ok
create type eobjects as (list oelement_container[])

statement ok
create type ecommerce as (name varchar, actionfields actionfields, objects eobjects)

statement ok
create type event as (
    eventid varchar,
    sessionid varchar,
    userid varchar,
    event varchar,
    timestamp timestamp,
    user_agent varchar,
    location loc, 
    "user" webusr,
    ecommerce ecommerce)

query I
select count(*) from r'$TSTSRCDIR/webclicks.json'
----
2

query TTTTTT
select e.eventid, e.sessionid, e.userid, e.event, e.timestamp, e.user_agent from ( select cast(t.json as event) as e from (select json from r'$TSTSRCDIR/webclicks.json') t)
----
996257967-103007874
47f07c1399c9c6bd1012861f9c5c958e042732e259b909e077f7e8967b650c75
8359e1f53c300c44ee0e8ba1610f620c589258a8a4752ea089cfc44fee51ff64
productDetail
2024-11-30 22:13:37.823000
Mozilla
996257967-103007874
47f07c1399c9c6bd1012861f9c5c958e042732e259b909e077f7e8967b650c75
8359e1f53c300c44ee0e8ba1610f620c589258a8a4752ea089cfc44fee51ff64
productDetail
2024-11-30 22:13:37.823000
Mozilla

query TT
select e.eventid, el.element.key from ( select cast(t.json as event) as e from (select json from r'$TSTSRCDIR/webclicks.json') t), unnest(e.location.list) el
----
996257967-103007874
hash
996257967-103007874
hostname
996257967-103007874
pageSubType
996257967-103007874
pageType
996257967-103007874
pathname
996257967-103007874
protocol
996257967-103007874
referrer
996257967-103007874
search
996257967-103007874
state
996257967-103007874
title
996257967-103007874
hash
996257967-103007874
hostname
996257967-103007874
pageSubType
996257967-103007874
pageType
996257967-103007874
pathname
996257967-103007874
protocol
996257967-103007874
referrer
996257967-103007874
search
996257967-103007874
state
996257967-103007874
title

query T
select cast(t.json as event) from (select json from r'$TSTSRCDIR/webclicks.json') t
----
("996257967-103007874", "47f07c1399c9c6bd1012861f9c5c958e042732e259b909e077f7e8967b650c75", "8359e1f53c300c44ee0e8ba1610f620c589258a8a4752ea089cfc44fee51ff64", "productDetail", 2024-11-30 22:13:37.823000, "Mozilla", ({(("hash", "da39a3ee5e6b4b0d3255bfef95601890afd80709")),(("hostname", "e13dacd9566ecf8efd4aff212960c02de20aa110")),(("pageSubType", "d5d4cd07616a542891b7ec2d0257b3a24b69856e")),(("pageType", "6b5cdf4073b8166e5cc01a2532469d2e356eebfd")),(("pathname", "0b28998c6a5efc0afb854752b1bba65f37c70230")),(("protocol", "c3437dbc7c1255d3a21d444d86ebf2e9234c22bd")),(("referrer", "27bbe94658bf6bd4c431052e2065de0457ec8546")),(("search", "da39a3ee5e6b4b0d3255bfef95601890afd80709")),(("state", "da39a3ee5e6b4b0d3255bfef95601890afd80709")),(("title", "d08339b839a6716a96334736c1c769091a0a8644"))}), ({(("customerId", "d5d4cd07616a542891b7ec2d0257b3a24b69856e")),(("customerType", "d5d4cd07616a542891b7ec2d0257b3a24b69856e")),(("isAuthenticated", "7cb6efb98ba5972a9b5090dc2e517fe14d12cb04"))}), ("detail", ({(("null", "null"))}), ({(("product", "null", ({(("brand", "b8884d21754edbf713af7000a67eac0efd5df8ea"))})))})))
("996257967-103007874", "47f07c1399c9c6bd1012861f9c5c958e042732e259b909e077f7e8967b650c75", "8359e1f53c300c44ee0e8ba1610f620c589258a8a4752ea089cfc44fee51ff64", "productDetail", 2024-11-30 22:13:37.823000, "Mozilla", ({(("hash", "da39a3ee5e6b4b0d3255bfef95601890afd80709")),(("hostname", "e13dacd9566ecf8efd4aff212960c02de20aa110")),(("pageSubType", "d5d4cd07616a542891b7ec2d0257b3a24b69856e")),(("pageType", "6b5cdf4073b8166e5cc01a2532469d2e356eebfd")),(("pathname", "0b28998c6a5efc0afb854752b1bba65f37c70230")),(("protocol", "c3437dbc7c1255d3a21d444d86ebf2e9234c22bd")),(("referrer", "27bbe94658bf6bd4c431052e2065de0457ec8546")),(("search", "da39a3ee5e6b4b0d3255bfef95601890afd80709")),(("state", "da39a3ee5e6b4b0d3255bfef95601890afd80709")),(("title", "d08339b839a6716a96334736c1c769091a0a8644"))}), ({(("customerId", "d5d4cd07616a542891b7ec2d0257b3a24b69856e")),(("customerType", "d5d4cd07616a542891b7ec2d0257b3a24b69856e")),(("isAuthenticated", "7cb6efb98ba5972a9b5090dc2e517fe14d12cb04"))}), ("detail", ({(("null", "null"))}), ({(("product", "null", ({(("brand", "b8884d21754edbf713af7000a67eac0efd5df8ea"))})))})))

statement ok
create table events(data event)

statement ok
insert into events select json from r'$TSTSRCDIR/webclicks.json'

query I
select count(*) from events
----
2

query T
select data.event from events
----
productDetail
productDetail


# clean up - the order should be reversed of creation for depended types

statement ok
drop table events

statement ok
drop type event

statement ok
drop type ecommerce

statement ok
drop type eobjects

statement ok
drop type oelement_container

statement ok
drop type oelement

statement ok
drop type attributes

statement ok
drop type actionfields

statement ok
drop type loc

statement ok
drop type webusr

statement ok
drop type elem

statement ok
drop type kv

