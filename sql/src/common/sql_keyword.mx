@f sql_keyword
@c

#include "sql_mem.h"
#include "sql_string.h"
#include "sql_keyword.h"

int keywords_init_done = 0;
keyword *keywords[HASH_SIZE];

int 
keyword_key(char *k, int *l)
{
	char *s = k;
	int h = 1;
	while (*k) {
		h *= (*k - 'a');
		k++;
	}
	*l = k - s;
	return (h < 0) ? -h : h;
}

void 
keywords_insert(char *k, int token)
{
	keyword *kw = NEW(keyword);
	int len = 0;
	int bucket = keyword_key(k=toLower(k), &len) & HASH_MASK;

	kw->keyword = k;
	kw->len = len;
	kw->token = token;
	kw->next = keywords[bucket];
	keywords[bucket] = kw;
}

keyword *
find_keyword(char *text)
{
	int len = 0;
	int bucket = keyword_key(mkLower(text), &len) & HASH_MASK;
	keyword *k = keywords[bucket];
	while (k) {
		if (len == k->len && strcmp(k->keyword, text) == 0)
			return k;
		k = k->next;
	}
	return NULL;
}

int 
keyword_exists(char *text)
{
	if (find_keyword(text)){
		return 1;
	}
	return 0;
}

void
keyword_init()
{
	int i;

	if (keywords_init_done)
		return;
	keywords_init_done = 1;

	for (i = 0; i < HASH_SIZE; i++)
		keywords[i] = NULL;
}

void 
keyword_exit()
{
	int i;

	if (keywords_init_done == 0)
		return;
	keywords_init_done = 0;

	for (i = 0; i < HASH_SIZE; i++) {
		keyword *k = keywords[i];
		while (k) {
			keyword *l = k;
			k = k->next;
			_DELETE(l->keyword);
			_DELETE(l);
		}
	}
}
