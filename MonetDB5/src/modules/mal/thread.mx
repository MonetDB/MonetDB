@' The contents of this file are subject to the MonetDB Public
@' License Version 1.0 (the "License"); you may not use this file
@' except in compliance with the License. You may obtain a copy of
@' the License at
@' http://monetdb.cwi.nl/Legal/MonetDBLicense-1.0.html
@'
@' Software distributed under the License is distributed on an "AS
@' IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
@' implied. See the License for the specific language governing
@' rights and limitations under the License.
@'
@' The Original Code is the Monet Database System.
@'
@' The Initial Developer of the Original Code is CWI.
@' Portions created by CWI are Copyright (C) 1997-2003 CWI.
@' All Rights Reserved.
@'
@' Contributor(s):
@'              Martin Kersten <Martin.Kersten@cwi.nl>
@'              Peter Boncz <Peter.Boncz@cwi.nl>
@'              Niels Nes <Niels.Nes@cwi.nl>
@'              Stefan Manegold  <Stefan.Manegold@cwi.nl>

@f thread
@t The Thread Module
@a M.L. Kersten
@v 1.0
@* Introduction
The MAL interpreter can be cloned to obtain parallel running threads.
Such threads share the stackframe of the caller for data exchange.
The consequence is that a thread may only terminate when it is
not the parent of one or more children
administered on a stack-frame variable.
@-
A thread block encountered in a MAL program leads to at most
one thread instance. This is detected by setting the thread
variable to the process id. The thread block is skipped when it
has already been set.
@-
A thread can be separated from its parent using the command
thread.exec(arguments). The thread identity is being returned.
A process can wait for all children using thread.wait().
A thread can be killed upon request, but may leave the system
in an inconsistent state. Preferably, a soft kill is given
which appears in the process as request to terminate the
interpreter loop.

[Most of the instructions are not yet implemented]
@mal
module thread;

pattern wait():void = CMDthreadWait
comment "Wait for all children to be finished";

pattern wait(pid:int...):void = CMDthreadWaitList
comment "Wait for all threads in the list to be finished";

pattern isDead(pid:int):bit = CMDthreadIsDead
commnet "Check availability of a child thread";

pattern kill(pid:int):void = CMDthreadKill
comment "Kill a specific thread";

pattern terminate(pid:int):void= CMDthreadTerminate
comment "Attempt a soft kill of a thread";

pattern exec(arg:any ...):int= CMDthreadExec
comment "Run a function independently";
@c
@+ The Module implementation
@h
#ifndef _MAL_ATOMS
#define _MAL_ATOMS
#include "mal_resolve.h"
#include "mal_stack.h"

#include "mal_function.h"
#define DEBUG_MAL_ATOMS 1
#endif /*  _MAL_ATOMS*/

@c
#include "thread.h"
str CMDthreadWait(MalBlkPtr m, MalStkPtr s, InstrPtr p){
	waitForChildren(s);
	return MAL_SUCCEED;
}
str CMDthreadWaitList(MalBlkPtr m, MalStkPtr s, InstrPtr p){
	return throwMessage("thread.wait", "not yet implemented\n");
}
str CMDthreadIsDead(MalBlkPtr m, MalStkPtr s, InstrPtr p){
	return throwMessage("thread.isDead", "not yet implemented\n");
}
str CMDthreadKill(MalBlkPtr m, MalStkPtr s, InstrPtr p){
	return throwMessage("thread.kill", "not yet implemented\n");
}
str CMDthreadTerminate(MalBlkPtr m, MalStkPtr s, InstrPtr p){
	return throwMessage("thread.terminate", "not yet implemented\n");
}
str CMDthreadExec(MalBlkPtr m, MalStkPtr s, InstrPtr p){
	return throwMessage("thread.exec", "not yet implemented\n");
}
