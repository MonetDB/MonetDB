@f mapi
@a N.J. Nes P. Boncz M. Kersten
@t Monets Simple Internet Interface
@v 1.1

This module contains a simple interface for setting up
internet connections and to initialize a client session.
Without loading this interface, Monet runs in administrator
mode. The information about activitated listeners is stored in 
a few tables view_mapi_owner, view_mapi_port, view_mapi_maxusers,
and view_mapi_users.

Clients may initialize a private listener to implement
specific services. For example, in an OLTP environment
it may make sense to have a listener for each transaction
type, which simply parses a sequence of transaction parameters.

The information about open listeners is maintain in global tables.
They behave as views on the actual state.
No protection is currently possible against malicious users changing them. 

Authorization of access to the server is handled as part
of the client record initialization phase.
@mal
module mapi;

command Listen():int  = MAPIlisten_default
	comment "Start a Mapi server with the default settings.";
command Listen(port:int, maxusers:int):int = MAPIlisten
	comment "Start a Mapi server.";
command Stop(port:int):bit = MAPIstop
	comment "Terminate a listener owned by the client";

# initialization code
function main();
	vm1:= bat.new(int,str);
	bat.setName(vm1,"view_mapi_owner");
	bat.setRoles(vm1,"mapi","owner");

	vm2:= bat.new(int,int);
	bat.setName(vm2,"view_mapi_port");
	bat.setRoles(vm2,"mapi","port");

	vm3:= bat.new(int,int);
	bat.setName(vm3,"view_mapi_maxusers");
	bat.setRoles(vm3,"mapi","maxusers");

	vm4:= bat.new(int,int);
	bat.setName(vm4,"view_mapi_users");
	bat.setRoles(vm4,"mapi","users");

	vm5:= bat.new(int,int);
	bat.setName(vm5,"view_mapi_timeout");
	bat.setRoles(vm5,"mapi","timeout");
end function;
	
@h
/*
 * The contents of this file are subject to the Monet Public
 * License Version 1.1 (the "License"); you may not use this file
 * except in compliance with the License. You may obtain a copy of
 * the License at 
 * http://www.monetsolutions.com/Download/Licensing/MonetPL-1.1.html
 * 
 * Software distributed under the License is distributed on an "AS
 * IS" basis, WITHOUT WARRANTY OF ANY KIND, either express or
 * implied. See the License for the specific language governing
 * rights and limitations under the License.
 * 
 * The Original Code is the Monet Database System.
 * 
 * The Initial Developer of the Original Code is CWI.
 * Portions created by CWI are Copyright (C) 1997-2001 CWI.  
 * All Rights Reserved.
 * 
 * Contributor(s): Martin Kersten <Martin.Kersten@cwi.nl>
 *		   Peter Boncz <Peter.Boncz@cwi.nl>
 *		   Niels Nes <Niels.Nes@cwi.nl>
 */

#ifndef MAPI_H
#define MAPI_H

#define MAPIPORT	50000
#define MAPIMAXUSERS 	5

#define DEBUG_MAPI	0

#endif /* MAPI_H */
@c
#include "mapi.h"
#include "mal_client.h"
#include  <sys/socket.h> 

#define SOCKPTR struct sockaddr *

void MAPIlistenThread(int sock)
{
	int 	msgsock;
	do {
#ifdef AIX
       		msgsock = accept(sock, 0, (size_t)0);
#else
       		msgsock = accept(sock, 0, (int *)0);
#endif

		if (msgsock == -1) {
			if (MT_geterrno() != EINTR) {
				GDKsyserror("monetServer: accept failed\n");
				return ;
	    		}
		} else if (msgsock > 0) {
			int i;
			FILE *fdin= fdopen(msgsock,"r");
			char name[MAPIBLKSIZE], *user = name;

			/* get user connection string */
			if( (i= fread(name,1,MAPIBLKSIZE,fdin)) != MAPIBLKSIZE){
				GDKerror("Block size error in mapi.mx\n");
				printf("%d bytes read\n",i);
				fflush(stdout);
				continue;
			}
/*
			for(i=0, *user=fgetc(fdin); i<MAPIBLKSIZE-1 && *user != '\n'; i++){
				user++;
				*user = fgetc(fdin);
			}
			*user = 0;
*/
			if( DEBUG_MAPI) 
				THRprintf(GDKerr, "mapi:Client accepted %s\n", name);
			scheduleClient(name, msgsock);
		}
	} while (1);
}


int MAPIlisten(int *ret, int *port, int *maxusers){
	struct sockaddr_in server;
	int 	sock;
#ifdef AIX
	size_t 	length;
#else
	int 	length;
#endif
	int    	on = 1;
	int 	msgsock;
	int	i = 0;
	MT_Id	pid;

	sock = socket(AF_INET, SOCK_STREAM, 0);
	if (sock < 0) {
		GDKsyserror("creation of stream socket failed\n");
		return GDK_FAIL;
	}
@-
Set server port and allow internet connections from any workstation.
Bind the socket to the server port.
The port id is obtained from the Monet configuration file.
@c
	if (*port == 0)
		*port = MAPIPORT;
	if( DEBUG_MAPI)
		THRprintf(GDKerr, "start at %d\n", *port);
	server.sin_family = AF_INET;
	server.sin_addr.s_addr = INADDR_ANY;
	server.sin_port = htons((unsigned short)((*port)&0xFFFF));
   	for (i=0;i<8;i++)
	    server.sin_zero[i]=0;
 
	setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, (char*) &on, sizeof on);

	length = sizeof(server);
	if (bind(sock, (SOCKPTR)&server, length) < 0) {
		GDKsyserror("binding to stream socket (%d) failed\n", *port);
		return GDK_FAIL;
	}
@-
Get the new information for the server socket and start listening.
@c
	if (getsockname(sock, (SOCKPTR)&server, &length) < 0) {
		GDKsyserror("getting socket name\n");
		return GDK_FAIL;
	}
	listen(sock, *maxusers); 

	if( MT_create_thread(&pid, MAPIlistenThread, (void*) sock) <0){
		GDKerror("Can not start internet thread\n");
		return GDK_FAIL;
	}
	if( DEBUG_MAPI)
		THRprintf(GDKerr, "Internet started at %d\n", server.sin_port);
	*ret = TRUE;
	return GDK_SUCCEED;
}

int MAPIlisten_default(int *ret){
	int port = MAPIPORT;
	int maxusers = MAPIMAXUSERS;
	return MAPIlisten(ret, &port, &maxusers);
}
@-
An internet connection may be terminated by the owner of the process only.
@c
int MAPIstop(int *ret, int *pid)
{
	printf("kill process %d\n",*pid);
	return GDK_SUCCEED;
}
