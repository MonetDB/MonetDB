#!@BASH@

PATH=/usr/bin:/bin:/usr/sbin:/sbin:$PATH
TMP=/tmp/.${0##*/}.$$

if      [ "$1" =       -l   ] ; then  LOGFILE="$2"      ; shift ; shift
  elif  [ "$1" != "${1#-l}" ] ; then  LOGFILE="${1#-l}" ; shift 
  else                                LOGFILE=""
fi
if [ "$LOGFILE" != "${LOGFILE%-*}" ] ; then
	TMP=${TMP%.$$}.${LOGFILE##*-}
	LOGFILE=${LOGFILE%-*}
fi
files="$*"
s1=-2
s2=-15
s3=-9

if [ ! "$files" ] ; then  exit 0 ; fi

function  LOG1  () { echo -e "${0##*/}:\t$*" ; }
function  LOG2  () {  LOG1 $* ; LOG1 $* >&2 ; }
function fLOG2  () {  LOG2 $*        1>>$TMP.out 2>>$TMP.err ; }
function fLOG2x () { fLOG2 $* ; "$@" 1>>$TMP.out 2>>$TMP.err ; }

case `uname` in
  Linux)
	pids1="`fuser $files | cut -d: -f2- | sed 's|[a-z]||g'`"
	PS="ps -f $pids1"
	FUSER="fuser -v"
	;;
  IRIX|IRIX64)
  	pids0="`fuser -q $files`"
  	pids1="`echo $pids0 | sed 's|,| |g'`"
	PS="ps -fp $pids0"
	FUSER="fuser"
	;;
  SunOS)
	pids1="`fuser $files 2>/dev/null`"
	pids0="`echo $pids1 | sed 's| |,|g'`"
	PS="ps -fp $pids0"
	FUSER="fuser"
	;;
# CYGWIN32_NT)
#	;;
esac

rm -f $TMP.{out,err}
if [ "$pids1" ] ; then
	pids2="(`echo $pids1 | sed 's/ /|/g'`)"
	fLOG2x	$PS
	fLOG2x	$FUSER   $files
	fLOG2x	fuser -k $files
	sleep 4
	if [ "`( ps -ef | egrep -w "$pids2" | egrep -v egrep ) 2>/dev/null`" ] ; then
		fLOG2x	kill -9 $pids1
	fi
fi
if [ "$LOGFILE" ] ; then
	sed 's|^|! |' $TMP.out >> $LOGFILE.out
	sed 's|^|! |' $TMP.err >> $LOGFILE.err
  else
	sed 's|^|! |' $TMP.out
	sed 's|^|! |' $TMP.err >&2
fi
rm -f $TMP.{out,err}
