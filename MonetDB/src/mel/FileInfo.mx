@f FileInfo
@a Niels Nes

@h 
#ifndef _FILEINFO_H_
#define _FILEINFO_H_

#include <stdio.h>
#include "list.h"

class FileInfo {
    public:
	FileInfo( FILE *f, int lineno, char *filename, 
		  char *basename,  FileInfo *parent = NULL);
	~FileInfo();
	static char *find_module( char *name, List<char> *dir_list );
	static FileInfo *open( char *filename, 
			       char *basename = NULL, 
			       FileInfo *parent = NULL );
	void close();
	int LineNo();
	void LineNo(int lineno);
	FILE *FilePtr();
	char *FileName();
	void FileName( char *fname );
	char *BaseName();
	FileInfo *Parent();
	void *Buffer();
	void Buffer( void *buf);
    private:
	FILE *_f;
	int _lineno;
	char *_filename;
	char *_basename;
	FileInfo *_parent;
	void *_buf;
};

#endif // _FILEINFO_H_

@C
#include "FileInfo.h"
#include "mel.h"
#include "ListIterator.h"
#include <stdio.h>
#include <string.h>

FileInfo::FileInfo( FILE *f, int lineno, char *filename, char *basename,
   	FileInfo *parent ){
	_f = f;
	_lineno = lineno;
	_filename = strdup(filename);
	_basename = strdup(basename);
	_parent = parent;
}

FileInfo::~FileInfo(){
   	delete( _filename );
   	delete( _basename );
}

int FileInfo::LineNo(){
	return _lineno;
}

void FileInfo::LineNo(int lineno){
	_lineno = lineno;
}

FILE *FileInfo::FilePtr(){
	return _f;
}

char *FileInfo::FileName(){
	return _filename;
}

void FileInfo::FileName( char *fname ){
   	delete(_filename);
	_filename = strdup( fname );
}

char *FileInfo::BaseName(){
	return _basename;
}

FileInfo *FileInfo::Parent(){
	return _parent;
}

void *FileInfo::Buffer(){
	return _buf;
}

void FileInfo::Buffer( void *buf ){
	_buf = buf;
}

static char *new_filename( char *dir, char *name, char *ext ){
	int len_dir = strlen(dir);
	int len_name = strlen(name);
	int len_ext  = strlen(ext);
	char *fn = new char [len_dir + 1 + len_name + len_ext + 1]; 
	strcpy( fn, dir );
	fn[len_dir] = '/';
	strcpy( fn+len_dir+1, name );
	strcpy( fn+len_dir+1+len_name, ext );
	return fn;
} 

char *FileInfo::find_module( char *name, List<char> *dir_list ){
	char *fn = new_filename( ".", name, ".m" );
	FILE *fp = fopen(fn, "r" );
	if (fp){
		fclose(fp);
		return fn;
	} else {
		delete fn;
		char *dir = NULL;
		ListIterator<char> *iter = dir_list->iterator();
		while (iter->next(dir)){
			fn = new_filename( dir, name, ".m" );
			fp = fopen(fn, "r" );
			if (fp){
				fclose(fp);
				return fn;
			} else {
				delete fn;
			}
		}
	}
	return NULL;
}
 
char *basename( char *fname ){
   	int l = strlen( fname );
	int i = 0;
	int start = 0;
	int end = 0;
	for( i = l-1; i >= 0; i-- ){
	   if (fname[i]=='.'){
	      	end = i-1;
	   }
	   if (fname[i]=='/'){
	      	start = i+1;
		break;
	   }
	}
	l  = end - start;
	char *b = new char [l+1];
	for (i = 0; i < l; i++ ){
	   	b[i] = fname[start+i];
	}
	b[i] = 0;
	return b;
}

FileInfo *FileInfo::open( char *fname, char *bname, FileInfo *parent ){
	FILE *fp    = fopen( fname, "r" );
	if (fp){
   		if (!bname){
		   	bname = basename( fname );
		}
		return new FileInfo(fp,1,fname,bname,parent );
	} else {
		return NULL;
	}
}

void FileInfo::close(){
	fclose(_f);
}
